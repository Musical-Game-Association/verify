<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mugassn音游社—验证页</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f7f7f7;
        }
        .container {
            text-align: center;
        }
        .title {
            font-size: 2em;
            margin-bottom: 20px;
        }
        canvas {
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .password-input {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="title">Mugassn音游社—身份验证</div>
    <button onclick="openModal()">点击验证</button>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>人机验证</h2>
            <img id="codeImg" class="code" onclick="showCode()" alt="校验码图" />
            <input type="text" id="inputCode" placeholder="请输入验证码" style="margin-top: 10px;">
            <button onclick="validateCode()">确定</button>
            <canvas id="captchaCanvas"></canvas>
        </div>
    </div>
    <input type="password" class="password-input" id="password" placeholder="请输入密码" style="display: none;">
    <button onclick="verifyAndRedirect()" style="display: none;">提交</button>
</div>

<script>
    var modal = document.getElementById("myModal");

    function openModal() {
        modal.style.display = "block";
        showCode();
    }

    function closeModal() {
        modal.style.display = "none";
        document.getElementById("password").style.display = "block";
        document.querySelector("button[type='submit']").style.display = "block";
    }

    // 页面加载完成时，生成随机验证码
    window.onload = function() {
        showCode();
    };

    // 窗口大小调整时，重新生成校验码
    window.onresize = function() {
        showCode();
    };

    // 展示验证码：将验证码赋值到dom的image上
    function showCode() {
        let image = document.getElementById("codeImg");
        let obj = drawCode();
        image.src = obj.base64;
        window.sessionStorage.setItem("text", obj.text);
    }

    // 校验验证码的正确性
    function validateCode() {
        let inputCode = document.getElementById("inputCode").value.toUpperCase();
        let text = window.sessionStorage.getItem("text").toUpperCase();
        if (inputCode === text) {
            alert("验证码正确");
            window.sessionStorage.setItem("textValidated", "true");
            closeModal(); // Close modal on successful validation
        } else {
            alert("验证码错误，请重新输入！");
            showCode(); // Refresh code on incorrect entry
        }
    }

    // 绘制验证码
    function drawCode() {
        let nums = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0",
            "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L",
            "M", "N", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z",
            "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m",
            "n", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"
        ];
        let text = "";

        let canvas = document.getElementById("captchaCanvas");
        canvas.width = 98;
        canvas.height = 45;
        let context = canvas.getContext("2d");
        context.fillStyle = "#00BEFD";
        context.fillRect(0, 0, canvas.width, canvas.height);
        context.fillStyle = "white";
        context.font = "25px Microsoft YaHei";
        let rand = [], x = [], y = [];
        for (let i = 0; i < 4; i++) {
            rand.push(rand[i]);
            rand[i] = nums[Math.floor(Math.random() * nums.length)];
            x[i] = i * 20 + 10;
            y[i] = Math.random() * 20 + 20;
            context.fillText(rand[i], x[i], y[i]);
        }

        for (let i = 0; i < 2; i++) {
            drawline(canvas, context);
        }

        for (let i = 0; i < 20; i++) {
            drawDot(canvas, context);
        }

        let base64 = convertCanvasToImage(canvas);

        text = rand.join("").toUpperCase();
        return { base64: base64, text: text };
    }

    function drawline(canvas, context) {
        context.moveTo(Math.floor(Math.random() * canvas.width), Math.floor(Math.random() * canvas.height));
        context.lineTo(Math.floor(Math.random() * canvas.width), Math.floor(Math.random() * canvas.height));
        context.lineWidth = 0.5;
        context.strokeStyle = "rgba(50,50,50,0.3)";
        context.stroke();
    }

    function drawDot(canvas, context) {
        let px = Math.floor(Math.random() * canvas.width),
            py = Math.floor(Math.random() * canvas.height);
        context.moveTo(px, py);
        context.lineTo(px + 1, py + 1);
        context.lineWidth = 0.1;
        context.stroke();
    }

    function convertCanvasToImage(canvas) {
        try {
            return canvas.toDataURL("image/png");
        } catch (e) {
            console.error("该浏览器版本不支持：canvas.toDataURL(\"image/png\")");
        }
    }

    function verifyAndRedirect() {
        let password = document.getElementById('password').value;
        if (password === '0220') {
            // Redirect only if CAPTCHA validated
            if (window.sessionStorage.getItem("textValidated") === "true") {
                window.location.href = 'https://score.mugassn.com';
            } else {
                alert("请先验证验证码！");
            }
        } else {
            alert('未查询到存在该验证码，请核实！');
        }
    }
</script>
</body>
</html>
